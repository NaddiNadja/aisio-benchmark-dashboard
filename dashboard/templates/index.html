<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='font-face.css') }}"
    />
    <title>AiSiO benchmark</title>
  </head>
  <body>
    <header>
      <h1>AiSIO is </h1>
      <iframe id="ratio-dashboard" src="/grafana/d/5d42317c-6e69-4a17-98a7-462f311bbaed/ratio?kiosk"></iframe>
      <h1>Times Faster than State of the Art</h1>
    </header>
    <main class="grid">
      <div id="grafana">
        <iframe id="benchmark-dashboard" src="/grafana/d/c83d24b6-3bf5-4963-9a71-6f1676d75f0e/aisio-benchmark?kiosk"></iframe>
      </div>
      <div>
        <iframe id="terminal"></iframe>
        <script>
          const iframeSrc = `http://${window.location.hostname}:8910`;
          document.getElementById('terminal').src = iframeSrc;
        </script>
        <!-- <img src="{{ url_for('static', filename='rec-crop.gif') }}?it=0"> -->
      </div>
      <div>
        <!-- 
        4k I/O
        SR-IOV enabled
        shuffled data / random
        ImageNet2012
        backends - posix, 
        file system is live 
        -->
        <h4 class="gradient">AiSIO: Accelerator-initiated Storage I/O</h4>
        <p>
          This demo runs a data loader benchmark using the ImageNet dataset to
          showcase AiSIO's breakthrough in GPU-optimized storage. As 
          <span class="medium gradient">1.2 million</span> small files stream in,
          progress bars track execution while the bandwidth gauges compare
          POSIX, GDS, and AiSIO performance. 
        </p>
        <p>
          Terminal commands reveal the dataset structure and demonstrate the ability
          of AiSIO to keep the <br><span class="medium gradient">file system 
          mounted</span> while the GPU processes data. This is possible with
          hardware multi-path via SR-IOV.
        </p>
      </div>
      <div>
        <h4 class="gradient">The future of AI</h4>
        <p>
          Small-file I/O is a critical bottleneck in AI training and inference
          workloads, especially with datasets like ImageNet. AiSIO addresses this
          challenge head-on, delivering <span class="medium gradient">scalable 
          performance</span> without sacrificing file system compatibility.
        </p>
      </div>
    </main>
    <script>
      const injectedcss = fetch("{{ url_for('static', filename='injected.css') }}").then(res => res.text());
      const fontfacecss = fetch("{{ url_for('static', filename='font-face.css') }}").then(res => res.text());
      let gifincrease = 0;
      
      const iframe1 = document.getElementById("benchmark-dashboard");
      iframe1.onload = async () => {
        const doc = iframe1.contentDocument || iframe1.contentWindow.document;
        const style = doc.head.appendChild(doc.createElement("style"));
        fontfacecss.then(css => style.innerHTML += css);
        injectedcss.then(css => style.innerHTML += css);

        await new Promise(resolve => setTimeout(resolve, 500))
        
        const bars = doc.querySelectorAll(".grafana-app #\\35 , #\\31 0 , #\\31 5 ");
        bars.forEach(el => {
          let container = el.querySelector(`div[style*="flex-direction: row-reverse"] :first-child`);
          container.innerHTML = `${Math.round(container.nextElementSibling.offsetWidth / container.parentElement.offsetWidth * 100)}%`;
          setInterval(() => {
            container.innerHTML = `${Math.round(container.nextElementSibling.offsetWidth / container.parentElement.offsetWidth * 100)}%`;
          }, 500);
        });

        let aisio = doc.querySelector(`.grafana-app #\\31 5  div[style*="flex-direction: row-reverse"] :first-child`);
        new MutationObserver(() => {
          if (aisio.nextElementSibling.offsetWidth < 5) {
            let gif = document.querySelector("#terminal img");
            gif.src = `{{url_for('static', filename='rec-crop.gif')}}?it=${++gifincrease}`
          }
        }).observe(aisio.nextElementSibling, {attributes: true});
      };

      const iframe2 = document.getElementById("ratio-dashboard");
      iframe2.onload = async () => {
        const doc = iframe2.contentDocument || iframe2.contentWindow.document;
        const style = doc.head.appendChild(doc.createElement("style"));
        fontfacecss.then(css => style.innerHTML += css);
        injectedcss.then(css => style.innerHTML += css);

        await new Promise(resolve => setTimeout(resolve, 500))

        const ratio = doc.querySelector(`div[style*="display: flex; flex-flow:"] [style*="line-height: 1.2;"] span`);
        if (!ratio.innerHTML.length) ratio.innerHTML = "9.11";
      };
    </script>
  </body>
</html>
